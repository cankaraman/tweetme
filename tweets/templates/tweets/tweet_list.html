{% extends "base.html" %}
{% block script %}
<script>
    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, '\\$&');
        var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

$(document).ready(function(){
    var query = getParameterByName('q')
    var tweetList = [];
    var nextTweetUrl;

    $(document.body).on("click", ".retweetBtn", function(e){
        e.preventDefault()
        console.log("clicked")
        var url = "/api" + $(this).attr("href")

        $.ajax({
            url: url,
            // data: formData,
            method: "GET",
            success: function(data){
                attachTweet(data, true, true)
                updateHashLinks()

            },
            error: function(data){
                console.log("error")
                console.log(data)
            }
        })

    })

    function updateHashLinks(){
        $(".media-body").each(function(data){

            var hashtagRegex = /(^|.)#([\w\d-]+)/g
            var usernameRegex = /(^|.)@([\w\d-]+)/g
            var currentHTML = $(this).html();
            var newText;
            newText = currentHTML.replace(hashtagRegex, "$1<a href='/tags/$2/'>#$2</a>")
            newText = newText.replace(usernameRegex, "$1<a href='/$2/'>@$2</a>")
            $(this).html(newText)
        })

    }

    function attachTweet(tweetValue, prepend, retweet){

        var dateDisplay = tweetValue.date_display;
        var tweetUser = tweetValue.user;
        var isRetweet = tweetValue.is_retweet
        var tweetContent = tweetValue.content;
        var tweetFormattedHtml; 

        if (retweet && tweetValue.parent){

            mainTweet = tweetValue.parent;
            tweetFormattedHtml = "<div class=\"media\"><div class=\"media-body\">"+ "<span class='grey-color'>" + "Retweet via "+ tweetUser.username + " on " +  dateDisplay + "</span>" + "<br/>" + mainTweet.content + "<br/> via " +"<a href='"+ tweetUser.url +"'>"+ mainTweet.user.username +"</a>" + " | " + mainTweet.date_display + " | " + "<a href='/tweet/" + mainTweet.id + "'>View</a>" +" | "+ "<a class='retweetBtn' href='/tweet/" + mainTweet.id +"/retweet" +  "'>Retweet</a>" + "</div></div><hr/>" 
        } else {

            tweetFormattedHtml = "<div class=\"media\"><div class=\"media-body\">"+ tweetContent + "<br/> via " +"<a href='"+ tweetUser.url +"'>"+ tweetUser.username +"</a>" + " | " + dateDisplay + " | " + "<a href='/tweet/" + tweetValue.id + "'>View</a>" +" | " + "<a class='retweetBtn' href='/tweet/" + tweetValue.id + "/retweet" + "'>Retweet</a>" + "</div></div><hr/>" 
        }
        if (prepend){
            $("#tweet-container").prepend(tweetFormattedHtml)
        } else {
            $("#tweet-container").append(tweetFormattedHtml)
        }
    }

    function parseTweets(){
        if (tweetList == 0) {
            $("#tweet-container").text("No tweets currently found")

        } else {
            $.each(tweetList, function(key,value){
                if (value.parent) {
                    attachTweet(value, false, true)
                } else {
                    attachTweet(value)
                }
            })
        }
    }


    function fetchTweets(url){
        var fetchUrl
        if (!url){
            fetchUrl = "/api/tweet/"
        }
        else{
            fetchUrl = url
        }
        $.ajax({
            url: fetchUrl,
            data: {
                "q": query
            },
            method: "GET",
            success: function(data){
                tweetList = data.results
                if (data.next){
                    nextTweetUrl = data.next
                } else {
                    $("#loadmore").css("display", "none")
                }

                parseTweets()
                updateHashLinks()
            },
            error: function(data){
                console.log("error")
                console.log(data)
            }
        })

    }

    fetchTweets()

    $("#loadmore").click(function(event){
        event.preventDefault()
        if (nextTweetUrl){
            fetchTweets(nextTweetUrl)

        }
    })

    var charStart = 140;
    var charCurrent = 0;

    $("#tweet-form").append("<span id='tweetCharsLeft'>" + charStart + "</span>")
    $("#tweet-form").keyup(function(e){
        var tweetValue = $(this).serializeArray()[1].value.length;
        charCurrent = charStart - tweetValue;
        spanChars = $("#tweetCharsLeft");
        spanChars.text(charCurrent);
        if (charCurrent > 0){
            spanChars.removeClass("grey-color")
            spanChars.removeClass("red-color")
        } else if (charCurrent == 0){
            spanChars.removeClass("red-color")
            spanChars.addClass("grey-color")
        } else if (charCurrent < 0){
            spanChars.removeClass("grey-color")
            spanChars.addClass("red-color")
        }

    })

    function createTweet(formData, this_){
        $.ajax({
            url: "/api/tweet/create",
            data: formData,
            method: "POST",
            success: function(data){
                // console.log(data)
                // clear text field
                this_.find("input[type=text], textarea").val("")
                attachTweet(data, true)
                updateHashLinks()

            },
            error: function(data){
                console.log("error")
                console.log(data.statusText)
                console.log(data.status)
            }
        })

    }

    $("#tweet-form").submit(function(event){
        event.preventDefault()
        var this_ = $(this)
        var formData = this_.serialize()
        if (charCurrent >= 0){
            createTweet(formData, this_);
        }
        else {
            console.log("tweet too long");
        }

    })

});
</script>
{% endblock script %}

{% block content  %}

<div class="row">
    <div class="col-sm-3 col-12" >
        <h1>{{ request.user }}</h1>
    </div>
    <div class="col-sm-9">
        {% if not request.GET.q %}
        <div class="">
            {% include "tweets/form.html" with form=create_form action_url=create_url btn_title="Tweet" form_id="tweet-form" %}

        </div>
        <hr/>
        {% endif %}

        <div id="tweet-container"> </div>

        <a href="#" id="loadmore">Load More Tweets</a>
    </div>
</div>
{% endblock content  %}

<!-- {% for obj in object_list %} -->
<!-- <div class="media"> -->
<!--     {% if obejct.image %} -->
<!--     <img class="mr-3" src="..." alt="Generic placeholder image"> -->
<!--     {% endif %} -->
<!--     <div class="media-body"> -->
<!--         <p>{{ obj.content}}<br/> -->
<!--         via {{ obj.user}} | {{ obj.timestamp|timesince }} ago | <a href="{{ obj.get_absolute_url }}">View</a> </p><br/><br/> --> 
<!--     </div> -->
<!-- </div> -->
<!-- <hr/> -->

<!-- {% empty %} -->
<!-- {% if request.GET.q %} -->
<!-- <p>No tweets found</p> -->
<!-- {% else %} -->
<!-- <p>No tweets yet.</p> -->
<!-- {% endif %} -->
<!-- {% endfor %} -->
